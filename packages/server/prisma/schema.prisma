// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum OrchestrationStatus {
  PENDING
  COLLECTING_REQUIREMENTS
  AWAITING_USER
  PLANNING
  AWAITING_APPROVAL
  APPROVED
  EXECUTING
  COMPLETED
  FAILED
}

enum AgentRunType {
  ORCHESTRATOR
  SUB_AGENT
}

enum AgentRunStatus {
  CREATING
  RUNNING
  WAITING_FOR_USER
  COMPLETED
  FAILED
}

enum AgentMessageRole {
  SYSTEM
  USER
  ASSISTANT
  TOOL
}

model User {
  id             String             @id @default(cuid())
  email          String?            @unique
  displayName    String?
  cursorUserId   String?            @unique
  createdAt      DateTime           @default(now())
  updatedAt      DateTime           @updatedAt
  credential     CursorCredential?
  orchestrations Orchestration[]
  repositories   UserRepository[]
}

model CursorCredential {
  id              String   @id @default(cuid())
  userId          String   @unique
  encryptedApiKey String
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  user User @relation(fields: [userId], references: [id])
}

model Repository {
  id             String          @id @default(cuid())
  provider       String
  name           String
  fullName       String          @unique
  defaultBranch  String?
  cloneUrl       String?
  installationId String?
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @default(now()) @updatedAt
  orchestrations Orchestration[]
  users          UserRepository[]
}

model Orchestration {
  id              String              @id @default(cuid())
  userId          String
  repositoryId    String
  title           String
  description     String
  status          OrchestrationStatus @default(PENDING)
  planAccepted    Boolean             @default(false)
  planVersion     Int                 @default(0)
  planPayload     Json?
  createdAt       DateTime            @default(now())
  updatedAt       DateTime            @updatedAt

  user         User         @relation(fields: [userId], references: [id])
  repository   Repository   @relation(fields: [repositoryId], references: [id])
  agentRuns    AgentRun[]
  conversations AgentMessage[]
}

model AgentRun {
  id               String          @id @default(cuid())
  orchestrationId  String
  parentRunId      String?
  cursorAgentId    String          @unique
  agentType        AgentRunType
  status           AgentRunStatus  @default(CREATING)
  name             String?
  planPayload      Json?
  metadata         Json?
  lastWebhookEvent Json?
  createdAt        DateTime        @default(now())
  updatedAt        DateTime        @updatedAt

  orchestration Orchestration @relation(fields: [orchestrationId], references: [id])
  parentRun     AgentRun?     @relation("AgentRunToSelf", fields: [parentRunId], references: [id])
  children      AgentRun[]    @relation("AgentRunToSelf")
  messages      AgentMessage[]
}

model AgentMessage {
  id              String           @id @default(cuid())
  orchestrationId String
  agentRunId      String?
  role            AgentMessageRole
  content         String
  createdAt       DateTime         @default(now())

  orchestration Orchestration @relation(fields: [orchestrationId], references: [id])
  agentRun      AgentRun?     @relation(fields: [agentRunId], references: [id])
}

model UserRepository {
  id            String      @id @default(cuid())
  userId        String
  repositoryId  String
  alias         String?
  createdAt     DateTime    @default(now())

  user       User       @relation(fields: [userId], references: [id])
  repository Repository @relation(fields: [repositoryId], references: [id])

  @@unique([userId, repositoryId])
}
